import { Stack } from "@mui/material";
import {
    Datagrid,
    DateField,
    FunctionField,
    ListContextProvider,
    NumberField,
    TextField,
    useListController,
} from "react-admin";

import { CustomPagination } from "../../commons/custom_fields/CustomPagination";
import { humanReadableDate } from "../../commons/functions";
import { getSettingListSize } from "../../commons/user_settings/functions";
import { VulnerabilityCheck } from "../types";

type VulnerabilityCheckEmbeddedListProps = {
    product: any;
    long_list: boolean;
};

const VulnerabilityCheckEmbeddedList = ({ product, long_list }: VulnerabilityCheckEmbeddedListProps) => {
    const listContext = useListController({
        filter: { product: Number(product.id) },
        perPage: 25,
        resource: "vulnerability_checks",
        sort: { field: "last_import", order: "DESC" },
        filterDefaultValues: {},
        disableSyncWithLocation: true,
        storeKey: "vulnerability_checks.embedded",
    });

    if (listContext.isLoading) {
        return <div>Loading...</div>;
    }

    if (listContext.data === undefined) {
        listContext.data = [];
    }

    function get_observations_url(vulnerability_check: any): string {
        if (vulnerability_check.branch == null) {
            return `..?displayedFilters=%7B%7D&filter=%7B%22current_status%22%3A%22Open%22%2C%22scanner%22%3A%22${vulnerability_check.scanner_name}%22%2C%22upload_filename%22%3A%22${vulnerability_check.filename}%22%2C%22api_configuration_name%22%3A%22${vulnerability_check.api_configuration_name}%22%7D&order=ASC&sort=current_severity`;
        }
        return `..?displayedFilters=%7B%7D&filter=%7B%22current_status%22%3A%22Open%22%2C%22branch%22%3A%22${vulnerability_check.branch}%22%2C%22scanner%22%3A%22${vulnerability_check.scanner_name}%22%2C%22upload_filename%22%3A%22${vulnerability_check.filename}%22%2C%22api_configuration_name%22%3A%22${vulnerability_check.api_configuration_name}%22%7D&order=ASC&sort=current_severity`;
    }

    return (
        <ListContextProvider value={listContext}>
            <div style={{ width: "100%" }}>
                <Stack direction="row" spacing={2} justifyContent="center" alignItems="flex-end"></Stack>
                <Datagrid
                    size={getSettingListSize()}
                    sx={{ width: "100%" }}
                    bulkActionButtons={false}
                    rowClick={(id, resource, record) => get_observations_url(record)}
                >
                    <TextField source="branch_name" label="Branch / Version" />
                    <TextField source="scanner_name" label="Scanner" />
                    {long_list && <TextField source="filename" />}
                    {long_list && <TextField source="api_configuration_name" label="API configuration name" />}
                    <NumberField source="last_import_observations_new" label="New" />
                    <NumberField source="last_import_observations_updated" label="Updated" />
                    <NumberField source="last_import_observations_resolved" label="Resolved" />
                    {long_list && <DateField source="last_import" showTime />}
                    {!long_list && (
                        <FunctionField<VulnerabilityCheck>
                            label="Last import"
                            sortBy="last_import"
                            render={(record) => (record ? humanReadableDate(record.last_import) : "")}
                        />
                    )}
                </Datagrid>
                <CustomPagination />
            </div>
        </ListContextProvider>
    );
};

export default VulnerabilityCheckEmbeddedList;
