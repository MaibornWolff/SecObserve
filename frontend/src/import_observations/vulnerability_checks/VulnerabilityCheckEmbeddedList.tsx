import { Paper, Stack } from "@mui/material";
import {
    Datagrid,
    DateField,
    ListContextProvider,
    NumberField,
    Pagination,
    TextField,
    useListController,
} from "react-admin";

type VulnerabilityCheckEmbeddedListProps = {
    product: any;
};

const VulnerabilityCheckEmbeddedList = ({ product }: VulnerabilityCheckEmbeddedListProps) => {
    const listContext = useListController({
        filter: { product: Number(product.id) },
        perPage: 25,
        resource: "vulnerability_checks",
        sort: { field: "branch_name", order: "ASC" },
        filterDefaultValues: {},
        disableSyncWithLocation: true,
        storeKey: "vulnerability_checks.embedded",
    });

    if (listContext.isLoading) {
        return <div>Loading...</div>;
    }

    if (listContext.data === undefined) {
        listContext.data = [];
    }

    function get_observations_url(vulnerability_check: any): string {
        return `../observations?displayedFilters=%7B%7D&filter=%7B%22current_status%22%3A%22Open%22%2C%22branch%22%3A%22${vulnerability_check.branch}%22%2C%22scanner%22%3A%22${vulnerability_check.scanner_name}%22%2C%22upload_filename%22%3A%22${vulnerability_check.filename}%22%2C%22api_configuration_name%22%3A%22${vulnerability_check.api_configuration_name}%22%7D&order=ASC&sort=current_severity`;
    }

    return (
        <ListContextProvider value={listContext}>
            <div style={{ width: "100%" }}>
                <Stack direction="row" spacing={2} justifyContent="center" alignItems="flex-end"></Stack>
                <Paper>
                    <Datagrid
                        size="medium"
                        sx={{ width: "100%" }}
                        rowClick={(id, resource, record) => get_observations_url(record)}
                    >
                        <TextField source="branch_name" label="Branch" />
                        <TextField source="scanner_name" />
                        <TextField source="filename" />
                        <TextField source="api_configuration_name" />
                        <NumberField source="last_import_observations_new" label="New" />
                        <NumberField source="last_import_observations_updated" label="Updated" />
                        <NumberField source="last_import_observations_resolved" label="Resolved" />
                        <DateField source="last_import" showTime />
                    </Datagrid>
                </Paper>
                <Pagination />
            </div>
        </ListContextProvider>
    );
};

export default VulnerabilityCheckEmbeddedList;
